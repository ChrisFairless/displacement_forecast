FROM python:3.11 AS builder
ENV PYTHONUNBUFFERED=1
ENV DOCKER_CONTAINER=1
ENV PATH="${HOME}/conda/bin:${PATH}"

# Install basic dependencies
RUN apt-get update

WORKDIR /app

SHELL ["/bin/bash", "-c"]

# Install Miniforge
RUN wget -O Miniforge3.sh "https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-$(uname)-$(uname -m).sh" \
    && bash Miniforge3.sh -b -p "${HOME}/conda" \
    && rm Miniforge3.sh

# Initialize conda
RUN . "${HOME}/conda/etc/profile.d/conda.sh" \
    && conda init bash \
    && echo ". ${HOME}/conda/etc/profile.d/conda.sh" >> ~/.bashrc \
    && conda install -y -c conda-forge mamba \
    && echo ". ${HOME}/conda/etc/profile.d/mamba.sh" >> ~/.bashrc

# Clone CLIMADA repository
RUN git clone --depth 1 --single-branch --branch main https://github.com/CLIMADA-project/climada_python.git
RUN git clone --depth 1 --single-branch --branch main https://github.com/CLIMADA-project/climada_petals.git

# Create and set up conda environment
RUN . "${HOME}/conda/etc/profile.d/conda.sh" \
    && . "${HOME}/conda/etc/profile.d/mamba.sh" \
    && mamba create -y -n climada_env "python=${PYTHON_VERSION}" \
    && mamba activate climada_env \
    && mamba env update -n climada_env -f climada_python/requirements/env_climada.yml \
    && pip install contextily \
    && pip install plotly \
    && cd climada_python \
    && pip install . \
    && cd ../climada_petals \
    && pip install . \
    && mamba clean -ay \
    && conda clean -ay \
    && rm -rf ~/.cache/pip

# Stage 2: Final image
FROM python:3.11-slim

ENV PYTHONUNBUFFERED=1
ENV DOCKER_CONTAINER=1
ENV PATH="${HOME}/conda/bin:${PATH}"

WORKDIR /app

SHELL ["/bin/sh", "-c"]

# Install minimal runtime dependencies
RUN apt-get update

# Copy conda environment and CLIMADA from builder
COPY --from=builder /root/conda /root/conda
COPY --from=builder /app/climada_python /app/climada_python
COPY --from=builder /app/climada_petals /app/climada_petals

WORKDIR /app/